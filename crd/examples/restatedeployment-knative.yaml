apiVersion: restate.dev/v1beta1
kind: RestateDeployment
metadata:
  name: my-greeter
  namespace: default
spec:
  # Deployment mode: knative for Knative Serving
  deploymentMode: knative

  # Knative-specific configuration
  knative:
    # Deployment tag - determines Restate deployment identity.
    # A tag groups multiple Knative Revisions under one Restate deployment.
    #
    # - Omit: Template changes create new Restate deployments (versioned updates)
    # - Specify: Template changes create new Knative Revisions within same
    #   Restate deployment (in-place updates)
    # - Change: Creates new Restate deployment with new deployment ID
    #
    # Example: tag "v1.0" maps to Restate deployment "dp_abc123"
    tag: "v1.0"

    # Scale-to-zero configuration
    minScale: 0          # Allow scaling to zero
    maxScale: 10         # Maximum 10 replicas
    target: 50           # Target 50 concurrent requests per replica

    # Optional: Route annotations for gradual rollout during in-place updates
    # (only applies when tag stays the same and template changes)
    # routeAnnotations:
    #   serving.knative.dev/rollout-duration: "300s"

  # Pod template - works same as ReplicaSet mode
  template:
    spec:
      containers:
        - name: greeter
          image: hashicorp/http-echo:latest
          # Port optional - operator auto-injects 9080/h2c if missing
          ports:
            - name: h2c
              containerPort: 9080
              protocol: TCP
          args:
            - -listen=:9080
            - -text=greeter-v1.0
          env:
            - name: GREETER_VERSION
              value: "v1.0.0"

  # Restate cluster registration
  restate:
    register:
      # Replace with your cluster name
      cluster: restate-test
    # Optional: force HTTP/1.1
    # use_http11: true

---
# Example 2: Versioned updates (no tag specified)
apiVersion: restate.dev/v1beta1
kind: RestateDeployment
metadata:
  name: my-service
  namespace: default
spec:
  deploymentMode: knative

  # No tag specified â†’ uses template hash
  # Each template change creates new Configuration + deployment ID
  knative:
    minScale: 1          # Keep at least 1 replica running
    maxScale: 20
    target: 100

  template:
    spec:
      containers:
        - name: service
          image: hashicorp/http-echo:latest
          args:
            - -listen=:9080
            - -text=service-v1

  restate:
    register:
      cluster: restate-test
